@using BE.Core.Entities.Bookings
@using BE.Core.Entities.Movies
@using BE.Core.Entities.CinemaInfrastructure
@using BE.Core.Entities.Concessions
@using BE.Core.Enums
@{
    ViewData["Title"] = "V√© ƒêi·ªán T·ª≠ - CineMax";
    Layout = "_Layout";
    var booking = ViewBag.Booking as Booking;
    var seats = ViewBag.Seats as List<Seat> ?? new List<Seat>();
    var showtime = ViewBag.Showtime as Showtime;
    var movie = ViewBag.Movie as Movie;
    var room = ViewBag.Room as Room;
    var cinema = ViewBag.Cinema as Cinema;
    var foods = ViewBag.Foods as List<(Food food, int quantity)> ?? new List<(Food, int)>();
    var bookingDetails = ViewBag.BookingDetails as List<BookingDetail> ?? new List<BookingDetail>();
    var seatList = string.Join(", ", seats.Select(s => $"{s.Row}{s.Number}"));
}

<!-- No-Print Navigation -->
<div class="no-print">
    <div class="container-fluid bg-dark py-3 mb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="@Url.Action("Index", "Movies")" class="text-white text-decoration-none">
                    <i class="bi bi-arrow-left me-2"></i>Quay l·∫°i
                </a>
                <div class="text-white">
                    <i class="bi bi-ticket-perforated-fill me-2"></i>
                    V√© ƒêi·ªán T·ª≠
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Alert -->
@if (booking?.Status == BookingStatus.Paid)
{
    <div class="container no-print mb-4" id="successAlert">
        <div class="alert alert-success border-0 shadow-sm alert-dismissible fade show">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                <div>
                    <h5 class="mb-1">ƒê·∫∑t v√© th√†nh c√¥ng!</h5>
                    <p class="mb-0 small">V√© c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n. Vui l√≤ng xu·∫•t tr√¨nh m√£ QR n√†y t·∫°i qu·∫ßy v√©.</p>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <script>
        // Auto dismiss success alert after 10 seconds
        setTimeout(function() {
            var alertElement = document.getElementById('successAlert');
            if (alertElement) {
                // Fade out effect
                alertElement.style.transition = 'opacity 1s ease-out';
                alertElement.style.opacity = '0';
                
                // Remove from DOM after transition
                setTimeout(function() {
                    alertElement.remove();
                }, 1000);
            }
        }, 10000); // 10 seconds
    </script>
}

<!-- E-TICKET CONTAINER -->
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <!-- TICKET CARD -->
            <div class="ticket-wrapper">
                <div class="ticket-card shadow-lg">
                    <!-- TICKET HEADER -->
                    <div class="ticket-header">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h1 class="cinema-brand mb-0">üé¨ CineMax</h1>
                                <p class="cinema-tagline mb-0">Your Premium Cinema Experience</p>
                            </div>
                            <div class="col-4 text-end">
                                @if (booking?.Status == BookingStatus.Paid)
                                {
                                    <span class="status-badge status-paid">
                                        <i class="bi bi-check-circle-fill"></i> ƒê√É THANH TO√ÅN
                                    </span>
                                }
                                else
                                {
                                    <span class="status-badge status-pending">
                                        <i class="bi bi-clock-fill"></i> CH·ªú THANH TO√ÅN
                                    </span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- TICKET BODY -->
                    <div class="ticket-body">
                        <div class="row">
                            <!-- LEFT COLUMN: Movie Info -->
                            <div class="col-lg-8">
                                <!-- Movie Title -->
                                <div class="movie-title-section mb-4">
                                    <div class="movie-label">PHIM</div>
                                    <h2 class="movie-title">@movie?.Title</h2>
                                    <div class="movie-meta">
                                        <span class="badge bg-danger me-2">@movie?.AgeRating</span>
                                        <span class="text-muted">@movie?.Duration ph√∫t</span>
                                    </div>
                                </div>

                                <!-- Screening Info Grid -->
                                <div class="screening-info">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="info-item">
                                                <i class="bi bi-building info-icon"></i>
                                                <div>
                                                    <div class="info-label">R·∫†P CHI·∫æU</div>
                                                    <div class="info-value">@cinema?.Name</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="info-item">
                                                <i class="bi bi-door-open info-icon"></i>
                                                <div>
                                                    <div class="info-label">PH√íNG</div>
                                                    <div class="info-value">@room?.Name</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="info-item">
                                                <i class="bi bi-calendar-event info-icon"></i>
                                                <div>
                                                    <div class="info-label">NG√ÄY CHI·∫æU</div>
                                                    <div class="info-value">@showtime?.StartTime.ToString("dd/MM/yyyy")</div>
                                                    <div class="info-subtext">@showtime?.StartTime.ToString("dddd", new System.Globalization.CultureInfo("vi-VN"))</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="info-item">
                                                <i class="bi bi-clock info-icon"></i>
                                                <div>
                                                    <div class="info-label">GI·ªú CHI·∫æU</div>
                                                    <div class="info-value">@showtime?.StartTime.ToString("HH:mm")</div>
                                                    <div class="info-subtext">ƒê·∫øn tr∆∞·ªõc 15 ph√∫t</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Seats Section -->
                                <div class="seats-section mt-4">
                                    <div class="info-label mb-2">
                                        <i class="bi bi-bookmark-fill me-2"></i>GH·∫æ NG·ªíI
                                    </div>
                                    <div class="seats-display">
                                        @foreach (var seat in seats)
                                        {
                                            <div class="seat-badge">@seat.Row@seat.Number</div>
                                        }
                                    </div>
                                    <div class="seat-details mt-2">
                                        <small class="text-muted">
                                            T·ªïng: @seats.Count gh·∫ø √ó 
                                            @foreach (var detail in bookingDetails)
                                            {
                                                var seat = seats.FirstOrDefault(s => s.Id == detail.SeatId);
                                                if (seat != null)
                                                {
                                                    <span>@detail.PriceAtBooking.ToString("N0")‚Ç´</span>
                                                    if (detail != bookingDetails.Last()) { <text>, </text> }
                                                }
                                            }
                                        </small>
                                    </div>
                                </div>

                                <!-- Food & Drinks -->
                                @if (foods.Any())
                                {
                                    <div class="food-section mt-4">
                                        <div class="info-label mb-2">
                                            <i class="bi bi-cup-straw me-2"></i>ƒê·ªí ƒÇN & N∆Ø·ªöC
                                        </div>
                                        <div class="food-list">
                                            @foreach (var (food, quantity) in foods)
                                            {
                                                <div class="food-item-row">
                                                    <span class="food-name">@food.Name <span class="text-muted">x@(quantity)</span></span>
                                                    <span class="food-price">@((food.Price * quantity).ToString("N0"))‚Ç´</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- Total Amount -->
                                <div class="total-section mt-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="total-label">T·ªîNG THANH TO√ÅN</span>
                                        <span class="total-amount">@booking?.TotalAmount.ToString("N0")‚Ç´</span>
                                    </div>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: QR Code -->
                            <div class="col-lg-4">
                                <div class="qr-section">
                                    <div class="qr-title">V√â ƒêI·ªÜN T·ª¨</div>
                                    
                                    <!-- QR Code Container -->
                                    <div class="qr-code-wrapper">
                                        <div class="qr-code-container" id="qrcode"></div>
                                    </div>

                                    <!-- Barcode Container -->
                                    <div class="barcode-wrapper mt-3">
                                        <svg id="barcode"></svg>
                                    </div>

                                    <!-- Booking Code -->
                                    <div class="booking-code">
                                        <div class="barcode-label">M√É ƒê·∫∂T V√â</div>
                                        <div class="barcode-value">#@booking?.Id.ToString().PadLeft(8, '0')</div>
                                    </div>

                                    <!-- Instructions -->
                                    <div class="qr-instructions">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Xu·∫•t tr√¨nh m√£ QR ho·∫∑c m√£ v·∫°ch t·∫°i qu·∫ßy v√© ƒë·ªÉ nh·∫≠n v√©
                                    </div>

                                    <!-- Action Buttons (No Print) -->
                                    <div class="action-buttons no-print">
                                        <button class="btn btn-cinema-red w-100 mb-2" onclick="downloadQR()">
                                            <i class="bi bi-download me-2"></i>T·∫£i QR Code
                                        </button>
                                        <button class="btn btn-outline-light w-100" onclick="window.print()">
                                            <i class="bi bi-printer me-2"></i>In v√©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TICKET FOOTER -->
                    <div class="ticket-footer">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="footer-info">
                                    <div class="small text-muted mb-1">Th√¥ng tin giao d·ªãch</div>
                                    <div class="d-flex gap-3 flex-wrap">
                                        <div>
                                            <small class="text-muted">M√£ GD:</small>
                                            <strong class="ms-1">@(booking?.TransactionId ?? "N/A")</strong>
                                        </div>
                                        <div>
                                            <small class="text-muted">Ng√†y ƒë·∫∑t:</small>
                                            <strong class="ms-1">@booking?.BookingDate.ToString("dd/MM/yyyy HH:mm")</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                                <div class="payment-badge">
                                    <i class="bi bi-credit-card me-2"></i>@booking?.PaymentMethod
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Perforation Lines -->
                <div class="perforation-line perforation-top"></div>
                <div class="perforation-line perforation-bottom"></div>
            </div>

            <!-- Bottom Actions (No Print) -->
            <div class="text-center mt-4 no-print">
                <a href="@Url.Action("MyBookings")" class="btn btn-outline-light me-2">
                    <i class="bi bi-list-ul me-2"></i>Xem t·∫•t c·∫£ v√©
                </a>
                <a href="@Url.Action("Index", "Movies")" class="btn btn-cinema-red">
                    <i class="bi bi-film me-2"></i>ƒê·∫∑t v√© ti·∫øp
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- JsBarcode Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        // Generate QR Code with booking data
        // Generate QR Code with JUST the booking code (simple and consistent)
        // Complex JSON often breaks QR rendering if too large or has special chars
        const bookingCode = '@booking?.Id.ToString().PadLeft(8, '0')';
        const bookingDataStr = JSON.stringify({
             code: bookingCode,
             id: @booking?.Id
        });

        // Create QR Code with custom styling
        const qrcodeContainer = document.getElementById('qrcode');
        try {
            new QRCode(qrcodeContainer, {
                text: bookingDataStr,
                width: 200,
                height: 200,
                colorDark: '#e11d48',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
        } catch (error) {
            console.error('QR Code generation failed:', error);
            // If QR fails, barcode will be the fallback
            document.querySelector('.qr-code-wrapper').style.display = 'none';
        }

        // Generate Barcode (Code128)
        try {
            JsBarcode("#barcode", bookingData.code, {
                format: "CODE128",
                width: 2,
                height: 60,
                displayValue: false,
                background: "transparent",
                lineColor: "#1e293b",
                margin: 0
            });
        } catch (error) {
            console.error('Barcode generation failed:', error);
            document.querySelector('.barcode-wrapper').style.display = 'none';
        }

        // Download QR Code as image
        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'CineMax-Ticket-@(booking?.Id).png';
                link.href = url;
                link.click();
            }
        }
    </script>

    <style>
        /* ==================== TICKET STYLING ==================== */
        .ticket-wrapper {
            position: relative;
            margin: 0 auto;
            max-width: 900px;
        }

        .ticket-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            overflow: hidden;
            color: #fff;
            position: relative;
        }

        /* Perforation Lines */
        .perforation-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background: repeating-linear-gradient(
                to right,
                transparent,
                transparent 10px,
                #475569 10px,
                #475569 20px
            );
            left: 0;
            z-index: 1;
        }

        .perforation-top {
            top: -1px;
        }

        .perforation-bottom {
            bottom: -1px;
        }

        /* Ticket Header */
        .ticket-header {
            background: linear-gradient(to right, #e11d48, #be123c);
            padding: 24px 32px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .cinema-brand {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .cinema-tagline {
            font-size: 12px;
            opacity: 0.9;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-paid {
            background: #10b981;
            color: #fff;
        }

        .status-pending {
            background: #f59e0b;
            color: #000;
        }

        /* Ticket Body */
        .ticket-body {
            padding: 32px;
        }

        /* Movie Title Section */
        .movie-title-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }

        .movie-label {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .movie-title {
            font-size: 32px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .movie-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Screening Info */
        .screening-info {
            margin-top: 24px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-icon {
            font-size: 24px;
            color: #e11d48;
            flex-shrink: 0;
        }

        .info-label {
            font-size: 10px;
            font-weight: 600;
            color: #94a3b8;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .info-subtext {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Seats Section */
        .seats-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .seats-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .seat-badge {
            background: linear-gradient(135deg, #e11d48, #be123c);
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(225, 29, 72, 0.3);
        }

        .seat-details {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 12px;
        }

        /* Food Section */
        .food-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .food-list {
            margin-top: 12px;
        }

        .food-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .food-item-row:last-child {
            border-bottom: none;
        }

        .food-name {
            color: #f1f5f9;
            font-weight: 500;
        }

        .food-price {
            color: #10b981;
            font-weight: 700;
        }

        /* Total Section */
        .total-section {
            background: linear-gradient(to right, #e11d48, #be123c);
            margin: 24px -32px -32px;
            padding: 20px 32px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .total-label {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .total-amount {
            font-size: 32px;
            font-weight: 800;
            color: #fff;
        }

        /* QR Section */
        .qr-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .qr-title {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #e11d48;
            margin-bottom: 20px;
            text-align: center;
        }

        .qr-code-wrapper {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        .qr-code-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .qr-code-container canvas {
            border-radius: 8px;
        }

        /* Barcode Wrapper */
        .barcode-wrapper {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .barcode-wrapper svg {
            max-width: 100%;
            height: auto;
        }

        .booking-code {
            text-align: center;
            margin: 20px 0;
            padding: 16px;
            background: rgba(225, 29, 72, 0.1);
            border-radius: 12px;
            border: 2px dashed #e11d48;
            width: 100%;
        }

        .barcode-label {
            font-size: 10px;
            font-weight: 600;
            color: #94a3b8;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .barcode-value {
            font-size: 24px;
            font-weight: 800;
            color: #e11d48;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .qr-instructions {
            font-size: 12px;
            color: #94a3b8;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .action-buttons {
            width: 100%;
        }

        /* Ticket Footer */
        .ticket-footer {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-info {
            color: #cbd5e1;
        }

        .payment-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #10b981;
        }

        /* ==================== PRINT STYLES ==================== */
        @@media print {
            body {
                background: #fff;
            }

            .no-print {
                display: none !important;
            }

            .ticket-card {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .ticket-wrapper {
                max-width: 100%;
            }

            .action-buttons {
                display: none !important;
            }
        }

        /* ==================== RESPONSIVE ==================== */
        @@media (max-width: 991px) {
            .ticket-header {
                padding: 20px 24px;
            }

            .cinema-brand {
                font-size: 24px;
            }

            .ticket-body {
                padding: 24px;
            }

            .movie-title {
                font-size: 24px;
            }

            .total-section {
                margin: 20px -24px -24px;
                padding: 16px 24px;
            }

            .total-amount {
                font-size: 24px;
            }

            .qr-section {
                margin-top: 24px;
            }
        }

        @@media (max-width: 575px) {
            .ticket-header {
                padding: 16px 20px;
            }

            .cinema-brand {
                font-size: 20px;
            }

            .ticket-body {
                padding: 20px;
            }

            .movie-title {
                font-size: 20px;
            }

            .seat-badge {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 50px;
            }

            .info-value {
                font-size: 14px;
            }

            .total-section {
                margin: 16px -20px -20px;
                padding: 16px 20px;
            }

            .total-amount {
                font-size: 20px;
            }

            .barcode-value {
                font-size: 20px;
            }
        }
    </style>
}
