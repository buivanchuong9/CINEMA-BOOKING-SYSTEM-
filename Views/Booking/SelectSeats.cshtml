@using BE.Core.Entities.Movies
@using BE.Core.Entities.CinemaInfrastructure
@using System.Text.Json
@{
    ViewData["Title"] = "Đặt Vé - CineMax";
    var showtime = ViewBag.Showtime as BE.Core.Entities.Movies.Showtime;
    var movie = ViewBag.Movie as Movie;
    var room = ViewBag.Room as Room;
    var seats = ViewBag.Seats as List<Seat> ?? new List<Seat>();
    var seatStatus = ViewBag.SeatStatus as List<BE.Application.DTOs.SeatStatusDto> ?? new List<BE.Application.DTOs.SeatStatusDto>();
    var foods = ViewBag.Foods as List<BE.Core.Entities.Concessions.Food> ?? new List<BE.Core.Entities.Concessions.Food>();
}

<!-- CSRF Token -->
@Html.AntiForgeryToken()

<!-- Booking Info Bar -->
<section class="booking-info-bar py-3 bg-dark">
    <div class="container">
        <div class="row g-3 align-items-center">
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-film text-cinema-red me-2 fs-5"></i>
                    <div>
                        <small class="text-muted d-block">Phim</small>
                        <strong id="bookingMovie">@movie?.Title</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-building text-popcorn-gold me-2 fs-5"></i>
                    <div>
                        <small class="text-muted d-block">Rạp</small>
                        <strong id="bookingCinema">@room?.Cinema?.Name</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-calendar3 text-cinema-red me-2 fs-5"></i>
                    <div>
                        <small class="text-muted d-block">Ngày & Giờ</small>
                        <strong id="bookingDateTime">@showtime?.StartTime.ToString("dd/MM/yyyy HH:mm")</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-badge-3d text-popcorn-gold me-2 fs-5"></i>
                    <div>
                        <small class="text-muted d-block">Phòng</small>
                        <strong id="bookingFormat">@room?.Name</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Seat Selection Section -->
<section class="py-5">
    <div class="container-fluid px-lg-5">
        <div class="row">
            <!-- Seat Map Column -->
            <div class="col-lg-9">
                <div class="text-center mb-4">
                    <h3 class="fw-bold mb-2">
                        <i class="bi bi-grid-3x3-gap me-2 text-cinema-red"></i>
                        Chọn Ghế Ngồi
                    </h3>
                    <p class="text-muted">Chọn ghế yêu thích để có trải nghiệm xem phim tốt nhất</p>
                </div>

                <!-- Seat Legend -->
                <div class="seat-legend mb-4">
                    <div class="d-flex justify-content-center gap-4 flex-wrap">
                        <div class="legend-item">
                            <div class="seat-icon seat-available"></div>
                            <span>Trống</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat-icon seat-selected"></div>
                            <span>Đang chọn</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat-icon seat-sold"></div>
                            <span>Đã bán</span>
                        </div>
                        <div class="legend-item">
                            <div class="seat-icon seat-vip"></div>
                            <span>VIP</span>
                        </div>
                    </div>
                </div>

                <!-- Cinema Screen -->
                <div class="cinema-screen mb-4">
                    <div class="screen-curve"></div>
                    <p class="screen-text">MÀN HÌNH</p>
                </div>

                <!-- Seat Map -->
                <div class="seat-map-wrapper" id="seatMapWrapper">
                    <div class="seat-map" id="seatMap">
                        <!-- Seats generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Booking Summary Column -->
            <div class="col-lg-3">
                <div class="booking-summary glass-card sticky-summary">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-receipt me-2 text-popcorn-gold"></i>
                        Tổng Kết Đặt Vé
                    </h5>

                    <!-- Selected Seats -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Ghế Đã Chọn</h6>
                        <div id="selectedSeatsList" class="selected-seats-list">
                            <p class="text-muted small text-center">Chưa chọn ghế</p>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Price Breakdown -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Standard (<span id="standardCount">0</span>)</span>
                            <span id="standardPrice">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>VIP (<span id="vipCount">0</span>)</span>
                            <span id="vipPrice">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Couple (<span id="coupleCount">0</span>)</span>
                            <span id="couplePrice">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Đồ ăn & nước</span>
                            <span id="foodTotal">0 ₫</span>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Food Menu -->
                    @if (foods.Any())
                    {
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-cup-straw me-2"></i>Đồ Ăn & Nước
                            </h6>
                            <div id="foodMenu" class="food-menu-compact">
                                <!-- Foods generated by JS -->
                            </div>
                        </div>
                        <hr class="border-secondary">
                    }

                    <!-- Total -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Tổng Cộng</h5>
                            <h4 class="mb-0 text-cinema-red fw-bold" id="totalPrice">0 ₫</h4>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <span id="totalSeats">0</span> ghế
                        </small>
                    </div>

                    <!-- Action Buttons -->
                    <button class="btn btn-cinema-red w-100 mb-2 rounded-pill" id="continueBtn" 
                            onclick="proceedToPayment()" disabled>
                        <i class="bi bi-credit-card me-2"></i>
                        Thanh Toán
                    </button>
                    <button class="btn btn-outline-light w-100 rounded-pill" onclick="clearSelection()">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>
                        Xóa Chọn
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Fixed Bottom Bar (Mobile) -->
<div class="fixed-bottom-bar d-lg-none">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-6">
                <div class="text-start">
                    <small class="text-muted d-block">Tổng Tiền</small>
                    <h5 class="mb-0 text-cinema-red fw-bold" id="totalPriceMobile">0 ₫</h5>
                </div>
            </div>
            <div class="col-6">
                <button class="btn btn-cinema-red w-100 rounded-pill" id="continueBtnMobile" 
                        onclick="proceedToPayment()" disabled>
                    Thanh Toán
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Inject server data to JavaScript
        window.showtimeData = @Html.Raw(JsonSerializer.Serialize(new {
            id = showtime?.Id ?? 0,
            startTime = showtime?.StartTime,
            basePrice = showtime?.BasePrice ?? 0
        }));
        
        window.movieData = @Html.Raw(JsonSerializer.Serialize(new {
            title = movie?.Title ?? "",
            startTime = showtime?.StartTime
        }));
        
        window.roomData = @Html.Raw(JsonSerializer.Serialize(new {
            name = room?.Name ?? "",
            cinemaName = room?.Cinema?.Name ?? ""
        }));
        
        @{
            var seatsList = seats.Select(s => new {
                id = s.Id,
                rowNumber = s.Row,
                seatNumber = s.Number,
                status = (int)s.Status,
                seatType = new {
                    name = s.SeatType?.Name ?? "Standard",
                    surchargeRatio = s.SeatType?.SurchargeRatio ?? 1.0m
                }
            }).ToList();
        }
        window.seatsData = @Html.Raw(JsonSerializer.Serialize(seatsList));
        
        window.seatStatusData = @Html.Raw(JsonSerializer.Serialize(seatStatus));
        
        @{
            var foodsList = foods.Select(f => new {
                id = f.Id,
                name = f.Name,
                price = f.Price,
                imageUrl = f.ImageUrl ?? "/images/placeholder-food.jpg"
            }).ToList();
        }
        window.foodsData = @Html.Raw(JsonSerializer.Serialize(foodsList));
    </script>
    <script src="~/js/seat-selection-real.js" asp-append-version="true"></script>
    
    <style>
        .cinema-screen {
            text-align: center;
            margin: 30px auto;
        }
        .screen-curve {
            width: 80%;
            height: 8px;
            background: linear-gradient(to bottom, #fff 0%, #666 100%);
            border-radius: 50% 50% 0 0;
            margin: 0 auto 10px;
            box-shadow: 0 3px 10px rgba(255, 255, 255, 0.3);
        }
        .screen-text {
            color: #888;
            font-size: 14px;
            letter-spacing: 2px;
        }
        
        .seat-map {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .seat-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .seat-row-label {
            width: 30px;
            font-weight: bold;
            color: #888;
        }
        
        .seat-row-seats {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }
        
        .seat {
            width: 35px;
            height: 35px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .seat-available {
            background: #4b5563;
            color: #fff;
        }
        
        .seat-available:hover {
            background: #6b7280;
            transform: scale(1.1);
        }
        
        .seat-selected {
            background: #10b981 !important;
            border-color: #fff !important;
            transform: scale(1.1);
        }
        
        .seat-sold, .seat-held {
            background: #dc2626;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .seat-vip {
            background: #f59e0b;
        }
        
        .seat-couple {
            width: 55px;
            background: #ec4899;
        }
        
        .seat-legend {
            padding: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .seat-icon {
            width: 25px;
            height: 25px;
            border-radius: 4px 4px 0 0;
        }
        
        .booking-summary {
            padding: 25px;
            border-radius: 16px;
            position: sticky;
            top: 100px;
        }
        
        .selected-seats-list {
            min-height: 50px;
        }
        
        .food-menu-compact {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .food-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .food-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
        }
        
        .food-info {
            flex: 1;
            min-width: 0;
        }
        
        .food-name {
            font-size: 13px;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .food-price {
            font-size: 12px;
            color: #10b981;
            margin: 0;
        }
        
        .food-quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .food-quantity {
            width: 40px;
            text-align: center;
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            padding: 2px;
        }
        
        .fixed-bottom-bar {
            background: rgba(0,0,0,0.95);
            padding: 15px 0;
            border-top: 1px solid #333;
            display: none;
        }
        
        @@media (max-width: 991px) {
            .fixed-bottom-bar {
                display: block;
            }
        }
    </style>
}
